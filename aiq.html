<!DOCTYPE html>
<html>
<head>
    <title>Air Quality Dashboard</title>

    <!-- ✅ CSS -->
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            font-family: Arial, sans-serif;
        }

        /* ✅ Left & Right Panel */
        #leftPanel, #rightPanel {
            width: 50%;
            height: 100vh;
        }

        #leftPanel {
            border-right: 2px solid #ccc;
            box-sizing: border-box;
            padding: 10px;
        }

        h2 {
            margin: 0;
            padding-bottom: 5px;
            font-size: 18px;
            text-align: center;
        }

        #chartContainer {
            width: 100%;
            height: calc(100vh - 40px);
        }

        #myChart {
            width: 100%;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- ✅ JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ✅ Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>

<body>

    <!-- ✅ LEFT PANEL (Chart) -->
    <div id="leftPanel">
        <h2>Air Quality Chart</h2>
        <div id="chartContainer">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <!-- ✅ RIGHT PANEL (Map) -->
    <div id="rightPanel">
        <div id="map"></div>
    </div>


    <!-- ✅ Firebase + Dashboard Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

        // ✅ FILL YOUR CONFIG HERE
       const firebaseConfig = {
  apiKey: "AIzaSyA7teVnGoPPSpLdEMK0gqoNDzw6oCtS-yU",
  authDomain: "air-quality-monitor-5ee5a.firebaseapp.com",
  databaseURL: "https://air-quality-monitor-5ee5a-default-rtdb.firebaseio.com",
  projectId: "air-quality-monitor-5ee5a",
  storageBucket: "air-quality-monitor-5ee5a.firebasestorage.app",
  messagingSenderId: "281309774855",
  appId: "1:281309774855:web:12b918c2f0b0f0053fd6a2",
  measurementId: "G-RT3KDCB911"
};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
let map;
let markers = [];
let chart;
let pathLine = null;   // <-- FIXED (required)


var blueIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
    shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41]
});

var yellowIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
    shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41]
});

var orangeIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
    shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41]
});

var redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41]
});
        // ✅ Initialize Map AFTER DOM loads
        $(document).ready(() => {

            // ✅ Setup Leaflet Map
            map = L.map('map').setView([20.5937, 78.9629],15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20
            }).addTo(map);

            // ✅ Fetch Firebase data live
            const dataRef = ref(db, 'airdata');
            onValue(dataRef, (snapshot) => {
                const raw = snapshot.val();
                if (!raw) return;

                const dataPoints = Object.values(raw).filter(p => p.lat && p.lon);

                updateChart(dataPoints);
                updateMap(dataPoints);
            });
        });

        // ✅ Update Chart
        function updateChart(dataPoints) {
            const labels = dataPoints.map(x => x.timestamp);
            const values = dataPoints.map(x => x.air_quality);

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('myChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Air Quality",
                        data: values,
                        borderColor: "blue",
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3
                    }]
                }
            });
        }

        // ✅ Update Map Markers
   function updateMap(dataPoints) {
    // Remove old markers
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    // Remove old path
    if (pathLine) map.removeLayer(pathLine);

    const latlngs = [];

    dataPoints.forEach((p, index) => {

        // --- Color Logic ---
        let icon = blueIcon;
        if (p.air_quality > 1200) icon = redIcon;
        else if (p.air_quality > 1000) icon = orangeIcon;
        else if (p.air_quality > 900) icon = yellowIcon;

        const marker = L.marker([p.lat, p.lon], { icon: icon }).addTo(map)
            .bindPopup(`<b>AQ:</b> ${p.air_quality}<br><b>Time:</b> ${p.timestamp}`);

        markers.push(marker);

        latlngs.push([p.lat, p.lon]);

        // --- Blinking latest marker ---
        if (index === dataPoints.length - 1) {
            const el = marker._icon;
            el.classList.add("blink");
        }
    });

    // --- Draw Path Line ---
    pathLine = L.polyline(latlngs, {
        color: "blue",
        weight: 3,
        opacity: 0.6
    }).addTo(map);

    // --- Auto-Follow Latest Marker + Smooth Zoom ---
    if (markers.length > 0) {
        const last = markers[markers.length - 1].getLatLng();
       map.flyTo(last, 16, {
        animate: true,
        duration: 1.2
        });

    }
}


    </script>

</body>
</html>









